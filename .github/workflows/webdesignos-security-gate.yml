name: WebDesignOS Security Gate

on:
  pull_request:
  push:
    branches: [ main ]
  # Optional but recommended if you use GitHub merge queues:
  merge_group:

permissions:
  contents: read

jobs:
  security-gate:
    name: security-gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # GitHub-hosted runners already include PowerShell (pwsh). :contentReference[oaicite:1]{index=1}
      - name: Run WebDesignOS security gate
        shell: pwsh
        run: |
          pwsh -NoProfile -File .\tools\security\check.ps1
          
  security-gate-fixtures-regression:
    name: security-gate-fixtures-regression
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fixtures must fail (regression)
        shell: bash
        run: |
          set +e
          pwsh -NoProfile -File ./tools/security/check.ps1 -IncludeFixtures
          code=$?
          if [ "$code" -eq 2 ]; then
            echo "OK: Fixtures failed as expected (exit 2)."
            exit 0
          fi
          echo "ERROR: Expected exit code 2, got $code"
          exit 1
