# WebDesignOS — Codex Agent Instructions (v1)

You are working inside the repo root (A:\AI\WebDesignOS). This project is **local-first** and uses a deterministic security workflow.

## Non-negotiables
1) You MAY propose changes, but you MUST NOT “approve” security-sensitive artifacts. Only deterministic scripts decide PASS/FAIL.
2) Never print secrets. Never echo raw .env values. If you need env vars, refer to them by name only.
3) Prefer minimal, reversible changes. Keep diffs small and explain each change.
4) Generated files are disposable; generators are authoritative.
   - If a file is generated by tools/write-files.ps1, update the generator manifest (tools/write-files.ps1), not just the generated output.

## What counts as security-sensitive
- SQL migrations, RLS policies, triggers, RPC functions
- Anything touching auth, roles, billing, or permissions
- Any reference to environment variables, keys, tokens, secrets

## Current security workflow
- Rulebook: .agents/security/SECURITY_RULEBOOK_v1.md
- Check specs: .agents/security/check-specs/v1/check-specs.json
- Runner: tools/security/run-checks.ps1
- Generator: tools/write-files.ps1 (writes/overwrites the above)

## How to run checks (PowerShell 7)
From repo root:
- pwsh -File .\tools\write-files.ps1
- pwsh -File .\tools\security\run-checks.ps1

## Current known issues / priorities
Priority A (must fix first):
- Make tools/security/run-checks.ps1 fully compatible with PowerShell 7 (no HashSet ctor ambiguity, no Linq ToArray assumptions).
- Ensure write-files.ps1 manifest matches generated outputs (no overwrite loops).

Priority B (after it runs):
- Replace approximate glob matching in Get-RepoFiles with deterministic glob->regex matching (no silent misses).
- Add high-value deterministic rules:
  - self-role escalation patterns in SQL (FAIL)
  - SECURITY DEFINER deny-by-default allowlist
  - dynamic SQL EXECUTE inside SECURITY DEFINER (FAIL unless allowlisted)
  - RLS footguns: USING true / WITH CHECK true on sensitive tables (FAIL)

## Deliverable format
When you change anything:
- Say which files you edited
- Provide the exact command(s) to run next
- Confirm expected output (e.g., FAIL:0 WARN:0) without guessing
